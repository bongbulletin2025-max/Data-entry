<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lucky Number Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: #f4f6f9;
      color: #333;
    }
    header {
      background: #4CAF50;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
    }
    .container {
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    h2, h3 {
      margin-top: 0;
      color: #444;
    }
    input, button {
      width: 100%;
      padding: 0.8rem;
      margin: 0.5rem 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #45a049;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    ul li {
      background: #f1f1f1;
      margin: 0.3rem 0;
      padding: 0.6rem;
      border-radius: 6px;
    }
    .logout {
      background: #e53935;
    }
    .logout:hover {
      background: #c62828;
    }
    .hidden {
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.6rem;
      text-align: center;
    }
    th {
      background: #4CAF50;
      color: white;
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, updateDoc, addDoc, collection, query, where, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // üîπ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase Config (‡¶Ø‡¶æ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®)
    const firebaseConfig = {
      apiKey: "AIzaSyDMrTQqAao4-zLcCTqlPnUi019muQK9kvE",
      authDomain: "data-entry-3b50f.firebaseapp.com",
      projectId: "data-entry-3b50f",
      storageBucket: "data-entry-3b50f.firebasestorage.app",
      messagingSenderId: "1022730252825",
      appId: "1:1022730252825:web:b3a85e4f7d55e62d15f088",
      measurementId: "G-2KJP9Q59XP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    // üîπ Login
    async function login() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) {
        alert("Login Failed: " + err.message);
      }
    }

    // üîπ Logout
    async function logout() {
      await signOut(auth);
      location.reload();
    }

    // üîπ Check Auth State
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById("loginCard").classList.add("hidden");

        // ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨ ‡¶∏‡ßá ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶ï‡¶ø‡¶®‡¶æ
        const adminRef = doc(db, "admins", user.uid);
        const adminSnap = await getDoc(adminRef);

        if (adminSnap.exists()) {
          document.getElementById("adminPanel").classList.remove("hidden");
          loadReports();
        } else {
          document.getElementById("playerPanel").classList.remove("hidden");
          loadBalance(user.uid);
          loadMyBets(user.uid);
          loadResults();
        }
      }
    });

    // =========================
    // üîπ Player Functions
    // =========================
    async function loadBalance(uid) {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        document.getElementById("balance").innerText = snap.data().tokens || 0;
      }
    }

    async function placeBet() {
      const number = document.getElementById("betNumber").value;
      const tokens = parseInt(document.getElementById("betTokens").value);

      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return alert("User not found");

      const balance = snap.data().tokens || 0;
      if (balance < tokens) {
        alert("Not enough tokens!");
        return;
      }

      await updateDoc(ref, { tokens: balance - tokens });
      await addDoc(collection(db, "bets"), {
        userId: currentUser.uid,
        number: number,
        tokens: tokens,
        timestamp: new Date()
      });

      alert("Bet Placed!");
      loadBalance(currentUser.uid);
    }

    function loadMyBets(uid) {
      const q = query(collection(db, "bets"), where("userId", "==", uid));
      onSnapshot(q, (snapshot) => {
        let html = "";
        snapshot.forEach(doc => {
          const bet = doc.data();
          html += `<li>Number: ${bet.number}, Tokens: ${bet.tokens}</li>`;
        });
        document.getElementById("myBets").innerHTML = html;
      });
    }

    function loadResults() {
      const q = collection(db, "results");
      onSnapshot(q, (snapshot) => {
        let html = "";
        snapshot.forEach(doc => {
          const res = doc.data();
          html += `<li>${doc.id}: ${res.result}</li>`;
        });
        document.getElementById("results").innerHTML = html;
      });
    }

    // =========================
    // üîπ Admin Functions
    // =========================
    async function addTokens() {
      const userId = document.getElementById("tokenUserId").value;
      const tokens = parseInt(document.getElementById("tokensToAdd").value);

      const ref = doc(db, "users", userId);
      const snap = await getDoc(ref);
      if (!snap.exists()) return alert("User not found");

      const balance = snap.data().tokens || 0;
      await updateDoc(ref, { tokens: balance + tokens });
      alert("Tokens Added!");
    }

    async function declareResult() {
      const gameId = document.getElementById("gameId").value;
      const result = document.getElementById("winningNumber").value;

      await updateDoc(doc(db, "results", gameId), {
        result: result
      });
      alert("Result Declared!");
    }

    function loadReports() {
      const q = collection(db, "bets");
      onSnapshot(q, (snapshot) => {
        let html = "<table><tr><th>User</th><th>Number</th><th>Tokens</th></tr>";
        snapshot.forEach(doc => {
          const bet = doc.data();
          html += `<tr><td>${bet.userId}</td><td>${bet.number}</td><td>${bet.tokens}</td></tr>`;
        });
        html += "</table>";
        document.getElementById("reports").innerHTML = html;
      });
    }

    // Expose
    window.login = login;
    window.logout = logout;
    window.placeBet = placeBet;
    window.addTokens = addTokens;
    window.declareResult = declareResult;
  </script>
</head>
<body>
  <header>Lucky Number Game</header>
  <div class="container">

    <!-- Login -->
    <div id="loginCard" class="card">
      <h2>Login</h2>
      <input id="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">
      <button onclick="login()">Login</button>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
      <div class="card">
        <h2>Admin Panel</h2>
        <button class="logout" onclick="logout()">Logout</button>

        <h3>Add Tokens</h3>
        <input id="tokenUserId" placeholder="User ID">
        <input id="tokensToAdd" type="number" placeholder="Tokens">
        <button onclick="addTokens()">Add</button>
      </div>

      <div class="card">
        <h3>Declare Result</h3>
        <input id="gameId" placeholder="Game ID">
        <input id="winningNumber" placeholder="Winning Number">
        <button onclick="declareResult()">Declare</button>
      </div>

      <div class="card">
        <h3>Reports</h3>
        <div id="reports"></div>
      </div>
    </div>

    <!-- Player Panel -->
    <div id="playerPanel" class="hidden">
      <div class="card">
        <h2>Player Panel</h2>
        <button class="logout" onclick="logout()">Logout</button>
        <h3>Balance: <span id="balance">0</span></h3>
      </div>

      <div class="card">
        <h3>Place Bet</h3>
        <input id="betNumber" placeholder="Number 0-9">
        <input id="betTokens" type="number" placeholder="Tokens">
        <button onclick="placeBet()">Bet</button>
      </div>

      <div class="card">
        <h3>My Bets</h3>
        <ul id="myBets"></ul>
      </div>

      <div class="card">
        <h3>Results</h3>
        <ul id="results"></ul>
      </div>
    </div>
  </div>
</body>
</html>
