<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Player Panel</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      updateDoc, 
      addDoc, 
      collection, 
      query, 
      where, 
      onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // আপনার Firebase Config বসান
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "XXXXXXX",
      appId: "XXXXXXX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    // প্লেয়ার লগইন
    async function loginPlayer() {
      const email = document.getElementById("email").value;
      const pass = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        alert("Login Successful!");
      } catch (err) {
        alert("Login Failed: " + err.message);
      }
    }

    // লগআউট
    async function logoutPlayer() {
      await signOut(auth);
      document.getElementById("loginForm").style.display = "block";
      document.getElementById("playerPanel").style.display = "none";
    }

    // অথেন্টিকেশন চেঞ্জ হলে
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("playerPanel").style.display = "block";

        loadBalance(user.uid);
        loadMyBets(user.uid);
        loadResults();
      }
    });

    // ব্যালান্স লোড
    async function loadBalance(uid) {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        document.getElementById("balance").innerText = snap.data().tokens;
      }
    }

    // বেট দেওয়া
    async function placeBet() {
      const number = document.getElementById("betNumber").value;
      const tokens = parseInt(document.getElementById("betTokens").value);

      if (!currentUser) return alert("Please login first");

      // ব্যালান্স চেক
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return alert("User not found");

      const balance = snap.data().tokens || 0;
      if (balance < tokens) {
        alert("Not enough tokens!");
        return;
      }

      // টোকেন কমানো
      await updateDoc(ref, { tokens: balance - tokens });

      // বেট সেভ করা
      await addDoc(collection(db, "bets"), {
        userId: currentUser.uid,
        number: number,
        tokens: tokens,
        timestamp: new Date()
      });

      alert("Bet Placed!");
      loadBalance(currentUser.uid);
    }

    // নিজের বেট লিস্ট
    function loadMyBets(uid) {
      const q = query(collection(db, "bets"), where("userId", "==", uid));
      onSnapshot(q, (snapshot) => {
        let html = "";
        snapshot.forEach(doc => {
          const bet = doc.data();
          html += `<li>Number: ${bet.number}, Tokens: ${bet.tokens}</li>`;
        });
        document.getElementById("myBets").innerHTML = html;
      });
    }

    // রেজাল্ট লোড
    function loadResults() {
      const q = collection(db, "results");
      onSnapshot(q, (snapshot) => {
        let html = "";
        snapshot.forEach(doc => {
          const res = doc.data();
          html += `<li>${doc.id}: ${res.result}</li>`;
        });
        document.getElementById("results").innerHTML = html;
      });
    }

    window.loginPlayer = loginPlayer;
    window.logoutPlayer = logoutPlayer;
    window.placeBet = placeBet;
  </script>
</head>
<body>
  <h1>Player Panel</h1>

  <div id="loginForm">
    <input id="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="loginPlayer()">Login</button>
  </div>

  <div id="playerPanel" style="display:none;">
    <button onclick="logoutPlayer()">Logout</button>
    <h2>Balance: <span id="balance">0</span></h2>

    <h2>Place Bet</h2>
    <input id="betNumber" placeholder="Number 0-9"><br>
    <input id="betTokens" placeholder="Tokens" type="number"><br>
    <button onclick="placeBet()">Bet</button>

    <h2>My Bets</h2>
    <ul id="myBets"></ul>

    <h2>Results</h2>
    <ul id="results"></ul>
  </div>
</body>
</html>
